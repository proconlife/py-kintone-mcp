**要求定義書: kintoneアプリ管理MCPサーバー (改訂版)**

**1. 目的**
Gemini CLIを通じて、kintoneのアプリケーション（アプリ）のライフサイクル管理（作成、公開、変更、削除）を効率的に行えるMCP（Model Context Protocol）サーバーをPythonで構築する。これにより、手動でのkintone操作を減らし、自動化されたワークフローを可能にする。

**2. 対象ユーザー**
*   kintoneアプリの管理・開発を行うエンジニア
*   Gemini CLIを利用してシステム操作を行うユーザー

**3. 機能要件**

*   **F1: kintoneアプリの作成**
    *   指定されたアプリ名で新しいkintoneアプリを作成できること。
    *   アプリのフォーム設定を定義できること。**詳細は「付録A: フォーム設定の詳細」を参照。**
        *   MCPサーバーへの入力形式は**JSON**を推奨し、kintone REST APIの `Add Form Fields` のリクエストボディに透過的に変換できること。
    *   アプリのアクセス権限を設定できること。**詳細は「付録B: アクセス権限設定の詳細」を参照。**
    *   作成されたアプリのIDを返却すること。
*   **F2: kintoneアプリの公開**
    *   指定されたアプリIDのアプリを公開（本番環境に適用）できること。
    *   公開処理後、`Get App Deploy Status` APIを使用してデプロイ完了をポーリングし、完了を待機すること。
*   **F3: kintoneアプリの変更**
    *   指定されたアプリIDのアプリのフォーム設定を変更できること。**詳細は「付録A: フォーム設定の詳細」を参照。**
        *   MCPサーバーへの入力形式は**JSON**を推奨し、kintone REST APIの `Update Form Fields` のリクエストボディに透過的に変換できること。
    *   アプリのアクセス権限を変更できること。**詳細は「付録B: アクセス権限設定の詳細」を参照。**
    *   変更後、F2と同様にアプリを公開し、デプロイ完了をポーリングすること。
*   **F4: kintoneアプリの削除**
    *   指定されたアプリIDのアプリを削除できること。
*   **F5: Gemini CLIからの操作**
    *   MCPサーバーがGemini CLIから呼び出し可能なAPIエンドポイントを提供すること。
    *   各機能（作成、公開、変更、削除）がGemini CLIのツールとして利用できるよう、適切な引数を受け取ること。
*   **F6: エラーハンドリング**
    *   kintone APIからのエラー（HTTP 4xx/5xx）や、入力値のバリデーションエラーが発生した場合、適切なエラーメッセージを返却すること。
    *   CLIには、エラー時に適切なexit codeとJSON形式のエラー構造体を返すこと。
*   **F7: 認証・認可**
    *   kintoneへの接続情報（サブドメイン、APIトークン、ユーザー名/パスワードなど）を安全に管理し、利用できること。
    *   APIトークンなどの機密情報は、環境変数や安全な設定ファイルで管理すること。将来的にはVault, AWS Secrets Managerなど外部KMSとの連携も検討する。

**4. 非機能要件**

*   **NF1: セキュリティ**
    *   kintone APIトークンなどの機密情報は、コードに直接記述せず、環境変数や安全な設定ファイルで管理すること。
    *   APIエンドポイントへのアクセスは、必要に応じて認証・認可の仕組みを検討すること（今回はGemini CLIからの呼び出しが前提）。
*   **NF2: 信頼性**
    *   kintone APIとの通信において、ネットワークエラーやタイムアウトに対応できること。
    *   予期せぬエラーが発生した場合でも、サーバーがクラッシュせず、適切なログを出力すること。
    *   アプリのデプロイ完了をポーリングすることで、非同期処理の信頼性を確保する。
*   **NF3: 保守性**
    *   コードはPythonのベストプラクティスに従い、可読性が高く、将来的な機能追加や変更が容易であること。
    *   適切なコメントとドキュメンテーションを提供すること。
    *   CLIからMCPへの入力はJSON/YAML、MCPからkintoneへのリクエストはAPIのJSONをそのまま転送するなど、インタフェース仕様を明確にすること。
*   **NF4: 運用性**
    *   サーバーの起動・停止が容易であること。
    *   処理の成功・失敗、エラー内容などをログに出力すること。OpenTelemetry形式での構造化ログ出力も検討し、監視基盤への転送を容易にする。

**5. 技術スタック**

*   **プログラミング言語**: Python 3.x
*   **Webフレームワーク**: Flask または FastAPI (MCPサーバーとしてAPIを提供するため)
*   **kintone APIクライアント**: `requests` ライブラリを使用してkintone REST APIを直接操作
*   **環境変数管理**: `python-dotenv`
*   **MCPプロトコル実装**: `modelcontextprotocol` ライブラリ
*   **その他**: ログ出力ライブラリなど

**6. 前提条件**

*   有効なkintone環境（サブドメイン、APIトークン、またはユーザー名/パスワード）が利用可能であること。
*   kintone APIトークンには、アプリの作成・公開・変更・削除に必要な権限が付与されていること。
*   Gemini CLIが利用可能な環境であること。

**7. 制約事項**

*   Gemini CLI経由での操作が必須であること。
*   Pythonでの実装であること。

---

**付録A: フォーム設定の詳細**

**A.1. サポートするフィールドタイプ**
以下のkintoneフィールドタイプをサポートする。
*   文字列（1行／複数行）
*   数値／計算式
*   日付／時刻／日時
*   ドロップダウン／ラジオボタン／チェックボックス／複数選択
*   ユーザー選択／グループ選択／組織選択
*   リッチテキスト／リンク
*   ルックアップ／関連レコード一覧
*   添付ファイル
*   テーブル（サブテーブル）

**A.2. フィールドプロパティの粒度**
`Add/Update Form Fields` APIで指定可能な以下のプロパティをサポートする。
*   `required`（必須）
*   `defaultValue` / `defaultNowValue`（初期値・現在日時）
*   `unique`（重複禁止）
*   数値フィールド: `min`/`max`, `displayScale`, `digit`（千位区切り）
*   計算式フィールド: `expression` / `hideExpression`

**A.3. MCPサーバーへの入力形式**
kintone REST APIの `Add Form Fields` および `Update Form Fields` のリクエストボディに準拠したJSON形式を想定する。これにより、MCPサーバー側での変換ロジックを最小限に抑え、保守性を高める。

**付録B: アクセス権限設定の詳細**

**B.1. サポートする権限レベル**
以下のkintone権限レベルをサポートする。
*   アプリ権限 (`Update App Permissions`)
*   レコード権限 (`Update Record Permissions`)
*   フィールド権限 (`Update Field Permissions`)

**B.2. サポート対象エンティティ**
以下のエンティティタイプをサポートする。
*   USER
*   GROUP
*   ORGANIZATION
*   CREATOR (アプリ権限のみ)
*   FIELD_ENTITY (レコード権限、フィールド権限のみ)

**B.3. エンティティの優先順位**
kintoneの権限評価はリストの上から優先されるため、CLIでの権限登録順序を制御できる仕様とする。

**B.4. 「Everyone」グループの既定動作**
デフォルトで最低限の閲覧権限を「Everyone」グループに付与するか、明示的な指定を必須とするかを実装時に決定する。

**B.5. Preview ↔ Live 反映タイミング**
権限APIはpre-liveを更新するため、F2（公開）およびF3（変更）のデプロイフローの一部として、`Deploy App Settings` を最後に呼び出すことで一貫性を保つ。

---

**補足で検討しておくと良い機能（将来的な拡張として）**

*   **差分プレビュー API**: `Get Form Fields` を利用して、変更内容の差分を生成・プレビューする機能。
*   **CLI コマンドテンプレート生成**: `gemini mcp app:create --template table.json` のように、CLIコマンドのテンプレートを生成する機能。
*   **OpenTelemetry 形式での構造化ログ**: 監視基盤への連携を容易にするためのログ形式。